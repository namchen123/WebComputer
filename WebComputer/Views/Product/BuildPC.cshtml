@{
    Layout = "~/Views/Shared/ComputerLayout.cshtml";
}

<div class="table mt-5" style="width: 90%; margin: auto;">
    <table id="build-table" class="table table-striped-columns border">
        <tr>
            <td class="">Chọn @ViewBag.categoryname</td>
            <td class="@ViewBag.categoryname"><button value=@ViewBag.categoryid class="btn btn-primary choose" data-bs-toggle="modal" data-bs-target="#option">+Chọn @ViewBag.categoryname</button></td>
        </tr>
        <tr>
            <td class="">Chọn @ViewBag.categoryname2</td>
            <td class="@ViewBag.categoryname2"><button value=@ViewBag.categoryid2 class="btn btn-primary choose" data-bs-toggle="modal" data-bs-target="#option">+Chọn @ViewBag.categoryname2</button></td>
        </tr>
        <tr>
            <td class="">Chọn @ViewBag.categoryname3</td>
            <td class="@ViewBag.categoryname3"><button value=@ViewBag.categoryid3 class="btn btn-primary choose" data-bs-toggle="modal" data-bs-target="#option">+Chọn @ViewBag.categoryname3</button></td>
        </tr>
        <tr>
            <td class="">Chọn @ViewBag.categoryname4</td>
            <td class="@ViewBag.categoryname4"><button value=@ViewBag.categoryid4 class="btn btn-primary choose" data-bs-toggle="modal" data-bs-target="#option">+Chọn @ViewBag.categoryname4</button></td>
        </tr>
        <tr>
            <td class="">Chọn @ViewBag.categoryname5</td>
            <td class="@ViewBag.categoryname5"><button value=@ViewBag.categoryid5 class="btn btn-primary choose" data-bs-toggle="modal" data-bs-target="#option">+Chọn @ViewBag.categoryname5</button></td>
        </tr>
        <tr>
            <td class="">Chọn @ViewBag.categoryname6</td>
            <td class="@ViewBag.categoryname6"><button value=@ViewBag.categoryid6 class="btn btn-primary choose" data-bs-toggle="modal" data-bs-target="#option">+Chọn @ViewBag.categoryname6</button></td>
        </tr>
        <tr>
            <td class="">Chọn @ViewBag.categoryname7</td>
            <td class="@ViewBag.categoryname7"><button value=@ViewBag.categoryid7 class="btn btn-primary choose" data-bs-toggle="modal" data-bs-target="#option">+Chọn @ViewBag.categoryname7</button></td>
        </tr>
        <tr>
            <td class="">Chọn @ViewBag.categoryname8</td>
            <td class="@ViewBag.categoryname8"><button value=@ViewBag.categoryid8 class="btn btn-primary choose" data-bs-toggle="modal" data-bs-target="#option">+Chọn @ViewBag.categoryname8</button></td>
        </tr>
        <tr>
            <td class="">Chọn @ViewBag.categoryname9</td>
            <td class="@ViewBag.categoryname9"><button value=@ViewBag.categoryid9 class="btn btn-primary choose" data-bs-toggle="modal" data-bs-target="#option">+Chọn @ViewBag.categoryname9</button></td>
        </tr>
        <tr>
            <td class="">Chọn @ViewBag.categoryname10</td>
            <td class="@ViewBag.categoryname10"><button value=@ViewBag.categoryid10 class="btn btn-primary choose" data-bs-toggle="modal" data-bs-target="#option">+Chọn @ViewBag.categoryname10</button></td>
        </tr>
        <tr>
            <td class="">Chọn @ViewBag.categoryname11</td>
            <td class="@ViewBag.categoryname11"><button value=@ViewBag.categoryid11 class="btn btn-primary choose" data-bs-toggle="modal" data-bs-target="#option">+Chọn @ViewBag.categoryname11</button></td>
        </tr>
        <tr>
            <td class="">Chọn @ViewBag.categoryname12</td>
            <td class="@ViewBag.categoryname12"><button value=@ViewBag.categoryid12 class="btn btn-primary choose" data-bs-toggle="modal" data-bs-target="#option">+Chọn @ViewBag.categoryname12</button></td>
        </tr>
        <tr>
            <td class="">Chọn @ViewBag.categoryname13</td>
            <td class="@ViewBag.categoryname13"><button value=@ViewBag.categoryid13 class="btn btn-primary choose" data-bs-toggle="modal" data-bs-target="#option">+Chọn @ViewBag.categoryname13</button></td>
        </tr>
    </table>

    <table id="totalPrice" class="bg-danger table w-25 table-striped-columns table-danger">
        <tr>
            <td>Chi phí dự tính:</td>
            <td class="total">0 đ</td>
        </tr>
    </table>
    <div class="d-flex w-25" style="gap: 10px">
        <button id="saveImage" class="btn btn-primary">Lưu ảnh</button>
        <button id="saveExcel" class="btn btn-primary">Lưu Excel</button>
    </div>
    <div id="option" class="modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modal title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Modal body text goes here.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        var data2;
        var currentTd;
        var button;
        var total;
        function renderOptions() {
            $(".modal-body").empty();
            if (data2) {
                data2.forEach(function (item) {
                    $(".modal-body").append(`
                        <div class="body-cart-item d-flex justify-content-between mt-3 border-bottom">
                            <div class="d-flex flex-grow-1 align-items-center" style="max-width: 260px;">
                                <img src="${item.image1}" style="width: 100px;" alt="">
                                <span class="ml-2">${item.name}</span>
                            </div>
                            <div class="flex-grow-1 text-center align-self-center">${item.price} đ</div>
                            <button type="button" class="btn btn-primary choose-product" data-id=${item.productId}>Chọn</button>
                        </div>
                    `);

                });
            }
        }
       
        $(document).on("click", ".choose", function () {
            button = $(this);
            currentTd = $(this).closest('td');
            var categoryId = $(this).val();
            $.ajax({
                url: '/api/ProductApi/GetById?id=' + categoryId,
                method: 'GET',
                success: function (data) {
                    console.log("Sản phẩm theo ID:", data);
                    data2 = data;
                    renderOptions();
                },
                error: function (err) {
                    console.error("Lỗi khi gọi API:", err);
                }
            });


        });

        $(document).on("click", ".choose-product", function () {
            var productId = $(this).data('id');
            var tdElement = currentTd;
            button.addClass('hidden');
            data2.forEach(function (item) {
                if (item.productId === productId) {
                    tdElement.append(`
                    <div class="body-cart-item d-flex justify-content-between mt-3">
                        <div class="d-flex flex-grow-1 align-items-center g-2" style="max-width: 280px; gap: 15px">
                            <img src="${item.image1}" style="width: 100px;" alt="">
                            <span class="ml-2">${item.name}</span>
                        </div>
                        <div class="item-price flex-grow-1 text-center align-self-center">${item.price} đ</div>
                        <button class="btn-delete text-danger border-0"><i class="fa-regular fa-trash-can"></i></button>
                    </div>`);
                }
            })
            $("#option").modal('hide');
            // Bạn có thể thêm logic xử lý sau khi chọn sản phẩm tại đây
            calculateTotal();
        });

        $(document).on("click", ".btn-delete", function () {
            var tdElement = $(this).closest('td');
            tdElement.find('button').removeClass('hidden');
            $(this).closest('.body-cart-item').remove();
            calculateTotal();
        });

        function calculateTotal() {
            let total = 0; // Khai báo biến total và khởi tạo giá trị
            $('table .item-price').toArray().forEach(function (item) {
                total += parseFloat($(item).text()); // Sử dụng $(item) để lấy giá trị
            });
            $('#totalPrice tr .total').html(total.toLocaleString('vi-VN') + "đ");
        }

        $("#saveImage").click(function () {
            html2canvas($("#build-table")[0]).then(canvas => {
                let link = document.createElement('a');
                link.download = 'table.png'; // Tên file ảnh
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        });

        // Xuất bảng ra file Excel
        $("#saveExcel").click(function () {
            var wb = XLSX.utils.table_to_book($("#build-table")[0], { sheet: "Sheet1" });
            XLSX.writeFile(wb, 'table.xlsx'); // Tên file Excel
        });
    });
</script>